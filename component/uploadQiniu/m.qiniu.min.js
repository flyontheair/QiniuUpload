/*!
 * qiniu-js-sdk v@VERSION
 *
 * Copyright 2015 by Qiniu
 * Released under GPL V2 License.
 *
 * GitHub: http://github.com/qiniu/js-sdk
 *
 * Date:2017-6-16 10:04
 */
(function(global){function createCookie(key,value,exp){var date=new Date();date.setTime(date.getTime()+(exp*24*60*60*1000));var expires="; expires="+date.toGMTString();document.cookie=key+"="+value+expires+"; path=/"}function readCookie(key){var nameEQ=key+"=";var ca=document.cookie.split(";");for(var i=0,max=ca.length;i<max;i++){var c=ca[i];while(c.charAt(0)===" "){c=c.substring(1,c.length)}if(c.indexOf(nameEQ)===0){return c.substring(nameEQ.length,c.length)}}return null}if(!window.localStorage){window.localStorage={setItem:function(key,value){createCookie(key,value,30)},getItem:function(key){return readCookie(key)},removeItem:function(key){createCookie(key,"",-1)}}}function QiniuJsSDK(){var that=this;this.detectIEVersion=function(){var v=4,div=document.createElement("div"),all=div.getElementsByTagName("i");while(div.innerHTML="<!--[if gt IE "+v+"]><i></i><![endif]-->",all[0]){v++}return v>4?v:false};var logger={MUTE:0,FATA:1,ERROR:2,WARN:3,INFO:4,DEBUG:5,TRACE:6,level:0};function log(type,args){var header="[qiniu-js-sdk]["+type+"]";var msg=header;for(var i=0;i<args.length;i++){if(typeof args[i]==="string"){msg+=" "+args[i]}else{msg+=" "+that.stringifyJSON(args[i])}}if(that.detectIEVersion()){console.log(msg)}else{args.unshift(header);console.log.apply(console,args)}if(document.getElementById("qiniu-js-sdk-log")){document.getElementById("qiniu-js-sdk-log").innerHTML+="<p>"+msg+"</p>"}}function makeLogFunc(code){var func=code.toLowerCase();logger[func]=function(){if(window.console&&window.console.log&&logger.level>=logger[code]){var args=Array.prototype.slice.call(arguments);log(func,args)}}}for(var property in logger){if(logger.hasOwnProperty(property)&&(typeof logger[property])==="number"&&!logger.hasOwnProperty(property.toLowerCase())){makeLogFunc(property)}}var qiniuUploadUrl;if(window.location.protocol==="https:"){qiniuUploadUrl="https://up.qbox.me"}else{qiniuUploadUrl="http://upload.qiniu.com"}var qiniuUploadUrls=["http://upload.qiniu.com","http://up.qiniu.com"];var qiniuUpHosts={"http":["http://upload.qiniu.com","http://up.qiniu.com"],"https":["https://up.qbox.me"]};var changeUrlTimes=0;this.resetUploadUrl=function(){var hosts=window.location.protocol==="https:"?qiniuUpHosts.https:qiniuUpHosts.http;var i=changeUrlTimes%hosts.length;qiniuUploadUrl=hosts[i];changeUrlTimes++;logger.debug("resetUploadUrl: "+qiniuUploadUrl)};this.isImage=function(url){url=url.split(/[?#]/)[0];return(/\.(png|jpg|jpeg|gif|bmp)$/i).test(url)};this.getFileExtension=function(filename){var tempArr=filename.split(".");var ext;if(tempArr.length===1||(tempArr[0]===""&&tempArr.length===2)){ext=""}else{ext=tempArr.pop().toLowerCase()}return ext};this.utf8_encode=function(argString){if(argString===null||typeof argString==="undefined"){return""}var string=(argString+"");var utftext="",start,end,stringl=0;start=end=0;stringl=string.length;for(var n=0;n<stringl;n++){var c1=string.charCodeAt(n);var enc=null;if(c1<128){end++}else{if(c1>127&&c1<2048){enc=String.fromCharCode((c1>>6)|192,(c1&63)|128)}else{if(c1&63488^55296>0){enc=String.fromCharCode((c1>>12)|224,((c1>>6)&63)|128,(c1&63)|128)}else{if(c1&64512^55296>0){throw new RangeError("Unmatched trail surrogate at "+n)}var c2=string.charCodeAt(++n);if(c2&64512^56320>0){throw new RangeError("Unmatched lead surrogate at "+(n-1))}c1=((c1&1023)<<10)+(c2&1023)+65536;enc=String.fromCharCode((c1>>18)|240,((c1>>12)&63)|128,((c1>>6)&63)|128,(c1&63)|128)}}}if(enc!==null){if(end>start){utftext+=string.slice(start,end)}utftext+=enc;start=end=n+1}}if(end>start){utftext+=string.slice(start,stringl)}return utftext};this.base64_decode=function(data){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o1,o2,o3,h1,h2,h3,h4,bits,i=0,ac=0,dec="",tmp_arr=[];if(!data){return data}data+="";do{h1=b64.indexOf(data.charAt(i++));h2=b64.indexOf(data.charAt(i++));h3=b64.indexOf(data.charAt(i++));h4=b64.indexOf(data.charAt(i++));bits=h1<<18|h2<<12|h3<<6|h4;o1=bits>>16&255;o2=bits>>8&255;o3=bits&255;if(h3===64){tmp_arr[ac++]=String.fromCharCode(o1)}else{if(h4===64){tmp_arr[ac++]=String.fromCharCode(o1,o2)}else{tmp_arr[ac++]=String.fromCharCode(o1,o2,o3)}}}while(i<data.length);dec=tmp_arr.join("");return dec};this.base64_encode=function(data){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o1,o2,o3,h1,h2,h3,h4,bits,i=0,ac=0,enc="",tmp_arr=[];if(!data){return data}data=this.utf8_encode(data+"");do{o1=data.charCodeAt(i++);o2=data.charCodeAt(i++);o3=data.charCodeAt(i++);bits=o1<<16|o2<<8|o3;h1=bits>>18&63;h2=bits>>12&63;h3=bits>>6&63;h4=bits&63;tmp_arr[ac++]=b64.charAt(h1)+b64.charAt(h2)+b64.charAt(h3)+b64.charAt(h4)}while(i<data.length);enc=tmp_arr.join("");switch(data.length%3){case 1:enc=enc.slice(0,-2)+"==";break;case 2:enc=enc.slice(0,-1)+"=";break}return enc};this.URLSafeBase64Encode=function(v){v=this.base64_encode(v);
    return v.replace(/\//g,"_").replace(/\+/g,"-")};this.URLSafeBase64Decode=function(v){v=v.replace(/_/g,"/").replace(/-/g,"+");return this.base64_decode(v)};this.createAjax=function(argument){var xmlhttp={};if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest()}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}return xmlhttp};this.parseJSON=function(data){if(window.JSON&&window.JSON.parse){return window.JSON.parse(data)}var rx_dangerous=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;var text=String(data);rx_dangerous.lastIndex=0;if(rx_dangerous.test(text)){text=text.replace(rx_dangerous,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}return eval("("+text+")")};this.stringifyJSON=function(obj){if(window.JSON&&window.JSON.stringify){return window.JSON.stringify(obj)}switch(typeof(obj)){case"string":return'"'+obj.replace(/(["\\])/g,"\\$1")+'"';case"array":return"["+obj.map(that.stringifyJSON).join(",")+"]";case"object":if(obj instanceof Array){var strArr=[];var len=obj.length;for(var i=0;i<len;i++){strArr.push(that.stringifyJSON(obj[i]))}return"["+strArr.join(",")+"]"}else{if(obj===null){return"null"}else{var string=[];for(var property in obj){if(obj.hasOwnProperty(property)){string.push(that.stringifyJSON(property)+":"+that.stringifyJSON(obj[property]))}}return"{"+string.join(",")+"}"}}break;case"number":return obj;case false:return obj;case"boolean":return obj}};this.trim=function(text){return text===null?"":text.replace(/^\s+|\s+$/g,"")};this.uploader=function(op){var reset_chunk_size=function(){var ie=that.detectIEVersion();var BLOCK_BITS,MAX_CHUNK_SIZE,chunk_size;var isSpecialSafari=(moxie.core.utils.Env.browser==="Safari"&&moxie.core.utils.Env.version<=5&&moxie.core.utils.Env.os==="Windows"&&moxie.core.utils.Env.osVersion==="7")||(moxie.core.utils.Env.browser==="Safari"&&moxie.core.utils.Env.os==="iOS"&&moxie.core.utils.Env.osVersion==="7");if(ie&&ie<9&&op.chunk_size&&op.runtimes.indexOf("flash")>=0){op.chunk_size=0}else{if(isSpecialSafari){op.chunk_size=0}else{BLOCK_BITS=20;MAX_CHUNK_SIZE=4<<BLOCK_BITS;chunk_size=plupload.parseSize(op.chunk_size);if(chunk_size>MAX_CHUNK_SIZE){op.chunk_size=MAX_CHUNK_SIZE}}}};var getHosts=function(hosts){var result=[];var uploadIndex=-1;for(var i=0;i<hosts.length;i++){var host=hosts[i];if(host.indexOf("upload")!==-1){uploadIndex=i}if(host.indexOf("-H")===0){result.push(host.split(" ")[2])}else{result.push(host)}}if(uploadIndex!==-1){var uploadDomain=result[uploadIndex];result[uploadIndex]=result[0];result[0]=uploadDomain}return result};var getPutPolicy=function(uptoken){var segments=uptoken.split(":");var ak=segments[0];var putPolicy=that.parseJSON(that.URLSafeBase64Decode(segments[2]));putPolicy.ak=ak;if(putPolicy.scope.indexOf(":")>=0){putPolicy.bucket=putPolicy.scope.split(":")[0];putPolicy.key=putPolicy.scope.split(":")[1]}else{putPolicy.bucket=putPolicy.scope}return putPolicy};var getUpHosts=function(uptoken){var putPolicy=getPutPolicy(uptoken);var uphosts_url=window.location.protocol+"//uc.qbox.me/v1/query?ak="+putPolicy.ak+"&bucket="+putPolicy.bucket;logger.debug("putPolicy: ",putPolicy);logger.debug("get uphosts from: ",uphosts_url);var ie=that.detectIEVersion();var ajax;if(ie&&ie<=9){ajax=new moxie.xhr.XMLHttpRequest();moxie.core.utils.Env.swf_url=op.flash_swf_url}else{ajax=that.createAjax()}ajax.open("GET",uphosts_url,false);var onreadystatechange=function(){logger.debug("ajax.readyState: ",ajax.readyState);if(ajax.readyState===4){logger.debug("ajax.status: ",ajax.status);if(ajax.status<400){var res=that.parseJSON(ajax.responseText);qiniuUpHosts.http=getHosts(res.http.up);qiniuUpHosts.https=getHosts(res.https.up);logger.debug("get new uphosts: ",qiniuUpHosts);that.resetUploadUrl()}else{logger.error("get uphosts error: ",ajax.responseText)}}};if(ie&&ie<=9){ajax.bind("readystatechange",onreadystatechange)}else{ajax.onreadystatechange=onreadystatechange}ajax.send();return};var getUptoken=function(file){if(!that.token||(op.uptoken_url&&that.tokenInfo.isExpired())){return getNewUpToken(file)}else{return that.token}};var getNewUpToken=function(file){if(op.uptoken){that.token=op.uptoken}else{if(op.uptoken_url){logger.debug("get uptoken from: ",that.uptoken_url);var ajax=that.createAjax();ajax.open("GET",that.uptoken_url+"?"+(+new Date()),false);ajax.send();if(ajax.status===200){var res=that.parseJSON(ajax.responseText);that.token=res.uptoken;var segments=that.token.split(":");var putPolicy=that.parseJSON(that.URLSafeBase64Decode(segments[2]));if(!that.tokenMap){that.tokenMap={}}var getTimestamp=function(time){return Math.ceil(time.getTime()/1000)};var serverTime=getTimestamp(new Date(ajax.getResponseHeader("date")));var clientTime=getTimestamp(new Date());that.tokenInfo={serverDelay:clientTime-serverTime,deadline:putPolicy.deadline,isExpired:function(){var leftTime=this.deadline-getTimestamp(new Date())+this.serverDelay;return leftTime<600}};logger.debug("get new uptoken: ",that.token);
    logger.debug("get token info: ",that.tokenInfo)}else{logger.error("get uptoken error: ",ajax.responseText)}}else{if(op.uptoken_func){logger.debug("get uptoken from uptoken_func");op.uptoken_func(file,function(res){if(res!=""){that.token=res}});logger.debug("get new uptoken: ",that.token)}else{logger.error("one of [uptoken, uptoken_url, uptoken_func] settings in options is required!")}}}if(that.token){getUpHosts(that.token)}return that.token};var getFileKey=function(up,file,func){var key="",unique_names=false;if(!op.save_key){unique_names=up.getOption&&up.getOption("unique_names");unique_names=unique_names||(up.settings&&up.settings.unique_names);if(unique_names){var ext=that.getFileExtension(file.name);key=ext?file.id+"."+ext:file.id}else{if(typeof func==="function"){key=func(up,file)}else{key=file.name}}}return key};if(op.log_level){logger.level=op.log_level}if(!op.domain){throw"domain setting in options is required!"}if(!op.browse_button){throw"browse_button setting in options is required!"}if(!op.uptoken&&!op.uptoken_url&&!op.uptoken_func){throw"one of [uptoken, uptoken_url, uptoken_func] settings in options is required!"}logger.debug("init uploader start");logger.debug("environment: ",moxie.core.utils.Env);logger.debug("userAgent: ",navigator.userAgent);var option={};var _Error_Handler=op.init&&op.init.Error;var _FileUploaded_Handler=op.init&&op.init.FileUploaded;op.init.Error=function(){};op.init.FileUploaded=function(){};that.uptoken_url=op.uptoken_url;that.token="";that.key_handler=typeof op.init.Key==="function"?op.init.Key:"";this.domain=op.domain;var ctx="";var speedCalInfo={isResumeUpload:false,resumeFilesize:0,startTime:"",currentTime:""};reset_chunk_size();logger.debug("invoke reset_chunk_size()");logger.debug("op.chunk_size: ",op.chunk_size);var defaultSetting={url:qiniuUploadUrl,multipart_params:{token:""}};var ie=that.detectIEVersion();if(ie&&ie<=9){defaultSetting.multipart_params.accept="text/plain; charset=utf-8";logger.debug("add accept text/plain in multipart params")}plupload.extend(option,op,defaultSetting);logger.debug("option: ",option);var uploader=new plupload.Uploader(option);logger.debug("new plupload.Uploader(option)");uploader.bind("Init",function(up,params){logger.debug("Init event activated");if(!op.get_new_uptoken){getNewUpToken(null)}});logger.debug("bind Init event");var mConfig=op.mConfig;var getUpType=function(file){if(typeof mConfig!="undefined"){for(var item in mConfig){if(typeof mConfig[item].typeKey!="undefined"&&mConfig[item].typeKey!=""){var key=","+mConfig[item].typeKey+",";var names=file.name.split(".");if(key.indexOf(names[names.length-1].toLowerCase())!=-1){file.upType=item}}if(typeof file.upType!="undefined"){break}}if(typeof file.upType=="undefined"){file.upType="Others"}}};uploader.bind("FilesAdded",function(up,files){for(var i=0;i<files.length;i++){getUpType(files[i])}logger.debug("FilesAdded event activated");var auto_start=up.getOption&&up.getOption("auto_start");auto_start=auto_start||(up.settings&&up.settings.auto_start);logger.debug("auto_start: ",auto_start);logger.debug("files: ",files);var is_ios=function(){if(moxie.core.utils.Env.OS.toLowerCase()==="ios"){return true}else{return false}};if(is_ios()){for(var i=0;i<files.length;i++){var file=files[i];var ext=that.getFileExtension(file.name);file.name=file.id+"."+ext}}if(auto_start){setTimeout(function(){console.log("Max up:",up);up.start();logger.debug("invoke up.start()")},0)}up.refresh()});logger.debug("bind FilesAdded event");uploader.bind("BeforeUpload",function(up,file){logger.debug("BeforeUpload event activated");if(up.settings&&up.settings.chunk_size){up.settings.chunk_size=0}if(typeof file.upType!="undefined"&&typeof mConfig[file.upType]!="undefined"&&typeof mConfig[file.upType].reOption!="undefined"){up.setOption(mConfig[file.upType].reOption)}file.speed=file.speed||0;ctx="";if(up.settings.get_new_uptoken){getNewUpToken(file)}var directUpload=function(up,file,func){speedCalInfo.startTime=new Date().getTime();var multipart_params_obj;if(op.save_key){multipart_params_obj={"token":that.token}}else{multipart_params_obj={"key":getFileKey(up,file,func),"token":that.token}}var ie=that.detectIEVersion();if(ie&&ie<=9){multipart_params_obj.accept="text/plain; charset=utf-8";logger.debug("add accept text/plain in multipart params")}logger.debug("directUpload multipart_params_obj: ",multipart_params_obj);var x_vars=op.x_vars;if(x_vars!==undefined&&typeof x_vars==="object"){for(var x_key in x_vars){if(x_vars.hasOwnProperty(x_key)){if(typeof x_vars[x_key]==="function"){multipart_params_obj["x:"+x_key]=x_vars[x_key](up,file)}else{if(typeof x_vars[x_key]!=="object"){multipart_params_obj["x:"+x_key]=x_vars[x_key]}}}}}up.setOption({"url":qiniuUploadUrl,"multipart":true,"chunk_size":is_android_weixin_or_qq()?op.max_file_size:undefined,"multipart_params":multipart_params_obj})};var is_android_weixin_or_qq=function(){var ua=navigator.userAgent.toLowerCase();if((ua.match(/MicroMessenger/i)||moxie.core.utils.Env.browser==="QQBrowser"||ua.match(/V1_AND_SQ/i))&&moxie.core.utils.Env.OS.toLowerCase()==="android"){return true
}else{return false}};var chunk_size=up.getOption&&up.getOption("chunk_size");chunk_size=chunk_size||(up.settings&&up.settings.chunk_size);logger.debug("uploader.runtime: ",uploader.runtime);logger.debug("chunk_size: ",chunk_size);if((uploader.runtime==="html5"||uploader.runtime==="flash")&&chunk_size){if(file.size<chunk_size||is_android_weixin_or_qq()){logger.debug("directUpload because file.size < chunk_size || is_android_weixin_or_qq()");directUpload(up,file,that.key_handler)}else{var localFileInfo=localStorage.getItem(file.name);var blockSize=chunk_size;if(localFileInfo){localFileInfo=that.parseJSON(localFileInfo);var now=(new Date()).getTime();var before=localFileInfo.time||0;var aDay=24*60*60*1000;if(now-before<aDay){if(localFileInfo.percent!==100){if(file.size===localFileInfo.total){file.percent=localFileInfo.percent;file.loaded=localFileInfo.offset;ctx=localFileInfo.ctx;speedCalInfo.isResumeUpload=true;speedCalInfo.resumeFilesize=localFileInfo.offset;if(localFileInfo.offset+blockSize>file.size){blockSize=file.size-localFileInfo.offset}}else{localStorage.removeItem(file.name)}}else{localStorage.removeItem(file.name)}}else{localStorage.removeItem(file.name)}}speedCalInfo.startTime=new Date().getTime();var multipart_params_obj={};var ie=that.detectIEVersion();if(ie&&ie<=9){multipart_params_obj.accept="text/plain; charset=utf-8";logger.debug("add accept text/plain in multipart params")}up.setOption({"url":qiniuUploadUrl+"/mkblk/"+blockSize,"multipart":false,"chunk_size":chunk_size,"required_features":"chunks","headers":{"Authorization":"UpToken "+getUptoken(file)},"multipart_params":multipart_params_obj})}}else{logger.debug("directUpload because uploader.runtime !== 'html5' || uploader.runtime !== 'flash' || !chunk_size");directUpload(up,file,that.key_handler)}if(up.settings&&up.settings.chunk_size){up.settings.chunk_size=0}if(typeof file.upType!="undefined"&&typeof mConfig[file.upType]!="undefined"&&typeof mConfig[file.upType].reOption!="undefined"){up.setOption(mConfig[file.upType].reOption)}});logger.debug("bind BeforeUpload event");uploader.bind("UploadProgress",function(up,file){logger.trace("UploadProgress event activated");speedCalInfo.currentTime=new Date().getTime();var timeUsed=speedCalInfo.currentTime-speedCalInfo.startTime;var fileUploaded=file.loaded||0;if(speedCalInfo.isResumeUpload){fileUploaded=file.loaded-speedCalInfo.resumeFilesize}file.speed=(fileUploaded/timeUsed*1000).toFixed(0)||0});logger.debug("bind UploadProgress event");uploader.bind("ChunkUploaded",function(up,file,info){logger.debug("ChunkUploaded event activated");logger.debug("ChunkUploaded file: ",file);logger.debug("ChunkUploaded info: ",info);var res=that.parseJSON(info.response);logger.debug("ChunkUploaded res: ",res);ctx=ctx?ctx+","+res.ctx:res.ctx;var leftSize=info.total-info.offset;var chunk_size=up.getOption&&up.getOption("chunk_size");chunk_size=chunk_size||(up.settings&&up.settings.chunk_size);if(leftSize<chunk_size){up.setOption({"url":qiniuUploadUrl+"/mkblk/"+leftSize});logger.debug("up.setOption url: ",qiniuUploadUrl+"/mkblk/"+leftSize)}up.setOption({"headers":{"Authorization":"UpToken "+getUptoken(file)}});localStorage.setItem(file.name,that.stringifyJSON({ctx:ctx,percent:file.percent,total:info.total,offset:info.offset,time:(new Date()).getTime()}))});logger.debug("bind ChunkUploaded event");var retries=qiniuUploadUrls.length;var unknow_error_retry=function(file){if(retries-->0){setTimeout(function(){that.resetUploadUrl();file.status=plupload.QUEUED;uploader.stop();uploader.start()},0);return true}else{retries=qiniuUploadUrls.length;return false}};uploader.bind("Error",(function(_Error_Handler){return function(up,err){logger.error("Error event activated");logger.error("err: ",err);var errTip="";var file=err.file;if(file){switch(err.code){case plupload.FAILED:errTip="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var max_file_size=up.getOption&&up.getOption("max_file_size");max_file_size=max_file_size||(up.settings&&up.settings.max_file_size);errTip="浏览器最大可上传"+max_file_size+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:errTip="文件格式验证失败，请确认支持上传。";break;case plupload.HTTP_ERROR:if(err.response===""){errTip=err.message||"未知网络错误。";if(!unknow_error_retry(file)){return}break}var errorObj=that.parseJSON(err.response);var errorText=errorObj.error;switch(err.status){case 400:errTip="请求报文格式错误。";break;case 401:errTip="客户端认证授权失败。请重试或提交反馈。";break;case 405:errTip="客户端请求错误。请重试或提交反馈。";break;case 579:errTip="资源上传成功，但回调失败。";break;case 599:errTip="网络连接异常。请重试或提交反馈。";if(!unknow_error_retry(file)){return}break;case 614:errTip="文件已存在。";try{errorObj=that.parseJSON(errorObj.error);errorText=errorObj.error||"file exists"}catch(e){errorText=errorObj.error||"file exists"}break;case 631:errTip="指定空间不存在。";break;case 701:errTip="上传数据块校验出错。请重试或提交反馈。";break;default:errTip="未知错误。";if(!unknow_error_retry(file)){return}break}errTip=errTip+"("+err.status+"："+errorText+")";break;case plupload.SECURITY_ERROR:errTip="安全配置错误。请联系网站管理员。";break;
    case plupload.GENERIC_ERROR:errTip="上传失败。请稍后再试。";break;case plupload.IO_ERROR:errTip="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:errTip="网站配置错误。请联系网站管理员。";uploader.destroy();break;default:errTip=err.message+err.details;if(!unknow_error_retry(file)){return}break}if(_Error_Handler){_Error_Handler(up,err,errTip)}}up.refresh()}})(_Error_Handler));logger.debug("bind Error event");uploader.bind("FileUploaded",(function(_FileUploaded_Handler){return function(up,file,info){logger.debug("FileUploaded event activated");logger.debug("FileUploaded file: ",file);logger.debug("FileUploaded info: ",info);var last_step=function(up,file,info){logger.debug("FileUploaded last step:",info);if(op.downtoken_url){var ajax_downtoken=that.createAjax();ajax_downtoken.open("POST",op.downtoken_url,true);ajax_downtoken.setRequestHeader("Content-type","application/x-www-form-urlencoded");ajax_downtoken.onreadystatechange=function(){if(ajax_downtoken.readyState===4){if(ajax_downtoken.status===200){var res_downtoken;try{res_downtoken=that.parseJSON(ajax_downtoken.responseText)}catch(e){throw ("invalid json format")}var info_extended={};plupload.extend(info_extended,that.parseJSON(info.response),res_downtoken);if(_FileUploaded_Handler){_FileUploaded_Handler(up,file,that.stringifyJSON(info_extended))}}else{uploader.trigger("Error",{status:ajax_downtoken.status,response:ajax_downtoken.responseText,file:file,code:plupload.HTTP_ERROR})}}};ajax_downtoken.send("key="+that.parseJSON(info.response).key+"&domain="+op.domain)}else{if(_FileUploaded_Handler){_FileUploaded_Handler(up,file,info)}}};var res=that.parseJSON(info.response);ctx=ctx?ctx:res.ctx;logger.debug("ctx: ",ctx);if(ctx){var key="";logger.debug("save_key: ",op.save_key);if(!op.save_key){key=getFileKey(up,file,that.key_handler);key=key?"/key/"+that.URLSafeBase64Encode(key):""}var fname="/fname/"+that.URLSafeBase64Encode(file.name);logger.debug("op.x_vars: ",op.x_vars);var x_vars=op.x_vars,x_val="",x_vars_url="";if(x_vars!==undefined&&typeof x_vars==="object"){for(var x_key in x_vars){if(x_vars.hasOwnProperty(x_key)){if(typeof x_vars[x_key]==="function"){x_val=that.URLSafeBase64Encode(x_vars[x_key](up,file))}else{if(typeof x_vars[x_key]!=="object"){x_val=that.URLSafeBase64Encode(x_vars[x_key])}}x_vars_url+="/x:"+x_key+"/"+x_val}}}var url=qiniuUploadUrl+"/mkfile/"+file.size+key+fname+x_vars_url;var ie=that.detectIEVersion();var ajax;if(ie&&ie<=9){ajax=new moxie.xhr.XMLHttpRequest();moxie.core.utils.Env.swf_url=op.flash_swf_url}else{ajax=that.createAjax()}ajax.open("POST",url,true);ajax.setRequestHeader("Content-Type","text/plain;charset=UTF-8");ajax.setRequestHeader("Authorization","UpToken "+that.token);var onreadystatechange=function(){logger.debug("ajax.readyState: ",ajax.readyState);if(ajax.readyState===4){localStorage.removeItem(file.name);var ajaxInfo;if(ajax.status===200){ajaxInfo={status:ajax.status,response:ajax.responseText,responseHeaders:ajax.getAllResponseHeaders(),};logger.debug("mkfile is success: ",ajaxInfo);last_step(up,file,ajaxInfo)}else{ajaxInfo={status:ajax.status,response:ajax.responseText,file:file,code:-200,responseHeaders:ajax.getAllResponseHeaders()};logger.debug("mkfile is error: ",ajaxInfo);uploader.trigger("Error",ajaxInfo)}}};if(ie&&ie<=9){ajax.bind("readystatechange",onreadystatechange)}else{ajax.onreadystatechange=onreadystatechange}ajax.send(ctx);logger.debug("mkfile: ",url)}else{last_step(up,file,info)}}})(_FileUploaded_Handler));logger.debug("bind FileUploaded event");uploader.init();logger.debug("invoke uploader.init()");logger.debug("init uploader end");return uploader};this.getUrl=function(key){if(!key){return false}key=encodeURI(key);var domain=this.domain;if(domain.slice(domain.length-1)!=="/"){domain=domain+"/"}return domain+key};this.imageView2=function(op,key){if(!/^\d$/.test(op.mode)){return false}var mode=op.mode,w=op.w||"",h=op.h||"",q=op.q||"",format=op.format||"";if(!w&&!h){return false}var imageUrl="imageView2/"+mode;imageUrl+=w?"/w/"+w:"";imageUrl+=h?"/h/"+h:"";imageUrl+=q?"/q/"+q:"";imageUrl+=format?"/format/"+format:"";if(key){imageUrl=this.getUrl(key)+"?"+imageUrl}return imageUrl};this.imageMogr2=function(op,key){var auto_orient=op["auto-orient"]||"",thumbnail=op.thumbnail||"",strip=op.strip||"",gravity=op.gravity||"",crop=op.crop||"",quality=op.quality||"",rotate=op.rotate||"",format=op.format||"",blur=op.blur||"";var imageUrl="imageMogr2";imageUrl+=auto_orient?"/auto-orient":"";imageUrl+=thumbnail?"/thumbnail/"+thumbnail:"";imageUrl+=strip?"/strip":"";imageUrl+=gravity?"/gravity/"+gravity:"";imageUrl+=quality?"/quality/"+quality:"";imageUrl+=crop?"/crop/"+crop:"";imageUrl+=rotate?"/rotate/"+rotate:"";imageUrl+=format?"/format/"+format:"";imageUrl+=blur?"/blur/"+blur:"";if(key){imageUrl=this.getUrl(key)+"?"+imageUrl}return imageUrl};this.watermark=function(op,key){var mode=op.mode;if(!mode){return false}var imageUrl="watermark/"+mode;if(mode===1){var image=op.image||"";if(!image){return false}imageUrl+=image?"/image/"+this.URLSafeBase64Encode(image):""
}else{if(mode===2){var text=op.text?op.text:"",font=op.font?op.font:"",fontsize=op.fontsize?op.fontsize:"",fill=op.fill?op.fill:"";if(!text){return false}imageUrl+=text?"/text/"+this.URLSafeBase64Encode(text):"";imageUrl+=font?"/font/"+this.URLSafeBase64Encode(font):"";imageUrl+=fontsize?"/fontsize/"+fontsize:"";imageUrl+=fill?"/fill/"+this.URLSafeBase64Encode(fill):""}else{return false}}var dissolve=op.dissolve||"",gravity=op.gravity||"",dx=op.dx||"",dy=op.dy||"";imageUrl+=dissolve?"/dissolve/"+dissolve:"";imageUrl+=gravity?"/gravity/"+gravity:"";imageUrl+=dx?"/dx/"+dx:"";imageUrl+=dy?"/dy/"+dy:"";if(key){imageUrl=this.getUrl(key)+"?"+imageUrl}return imageUrl};this.imageInfo=function(key){if(!key){return false}var url=this.getUrl(key)+"?imageInfo";var xhr=this.createAjax();var info;var that=this;xhr.open("GET",url,false);xhr.onreadystatechange=function(){if(xhr.readyState===4&&xhr.status===200){info=that.parseJSON(xhr.responseText)}};xhr.send();return info};this.exif=function(key){if(!key){return false}var url=this.getUrl(key)+"?exif";var xhr=this.createAjax();var info;var that=this;xhr.open("GET",url,false);xhr.onreadystatechange=function(){if(xhr.readyState===4&&xhr.status===200){info=that.parseJSON(xhr.responseText)}};xhr.send();return info};this.get=function(type,key){if(!key||!type){return false}if(type==="exif"){return this.exif(key)}else{if(type==="imageInfo"){return this.imageInfo(key)}}return false};this.pipeline=function(arr,key){var isArray=Object.prototype.toString.call(arr)==="[object Array]";var option,errOp,imageUrl="";if(isArray){for(var i=0,len=arr.length;i<len;i++){option=arr[i];if(!option.fop){return false}switch(option.fop){case"watermark":imageUrl+=this.watermark(option)+"|";break;case"imageView2":imageUrl+=this.imageView2(option)+"|";break;case"imageMogr2":imageUrl+=this.imageMogr2(option)+"|";break;default:errOp=true;break}if(errOp){return false}}if(key){imageUrl=this.getUrl(key)+"?"+imageUrl;var length=imageUrl.length;if(imageUrl.slice(length-1)==="|"){imageUrl=imageUrl.slice(0,length-1)}}return imageUrl}return false}}var Qiniu=new QiniuJsSDK();global.Qiniu=Qiniu;global.QiniuJsSDK=QiniuJsSDK})(window);